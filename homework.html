<script>
  const ctx = document.getElementById('systemChart').getContext('2d');
  const pieCtx = document.getElementById('pieChart').getContext('2d');
  let chartType = 'line';
  let updateInterval = 30000;
  let intervalHandle = null;

  const alertAudio = new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg");
  alertAudio.volume = 1.0;

  const createSystemChart = (type) => {
    chartType = type;
    return new Chart(ctx, {
      type: type,
      data: {
        labels: [],
        datasets: [
          {
            label: 'CPU (%)',
            data: [],
            borderColor: '#444',
            backgroundColor: type === 'bar' ? 'rgba(68, 68, 68, 0.5)' : 'transparent',
            barPercentage: 0.5,
            fill: false
          },
          {
            label: 'RAM (%)',
            data: [],
            borderColor: '#aaa',
            backgroundColor: type === 'bar' ? 'rgba(170, 170, 170, 0.5)' : 'transparent',
            barPercentage: 0.5,
            fill: false
          },
          {
            label: 'Disk (%)',
            data: [],
            borderColor: '#87CEFA',
            backgroundColor: type === 'bar' ? 'rgba(135, 206, 250, 0.5)' : 'transparent',
            barPercentage: 0.5,
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        animation: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              stepSize: 10
            }
          }
        }
      }
    });
  };

  let systemChart = createSystemChart(chartType);

  const pieChart = new Chart(pieCtx, {
    type: 'pie',
    data: {
      labels: ['CPU', 'RAM', 'Disk'],
      datasets: [{
        data: [0, 0, 0],
        backgroundColor: ['#444', '#aaa', '#87CEFA']
      }]
    },
    options: {
      responsive: true
    }
  });

  async function updateChart() {
    try {
      const response = await fetch('/metrics');
      const data = await response.json();
      const cpu = data.cpu;
      const ram = data.ram.percent;
      const disk = data.disk.percent;
      const time = new Date().toLocaleTimeString();

      document.getElementById('cpu-usage').textContent = `${cpu}%`;
      document.getElementById('ram-usage').textContent = `${ram}%`;
      document.getElementById('disk-usage').textContent = `${disk}%`;

      const threshold = parseInt(document.getElementById("cpuThreshold").value);
      if (cpu > threshold) {
        alertAudio.play().catch(err => console.warn("사운드 재생 실패:", err));
        setTimeout(() => {
          alert(`⚠️ CPU 사용률 ${cpu}% (임계치 ${threshold}%) 초과!`);
          alertAudio.pause();
          alertAudio.currentTime = 0;
        }, 10);
      }

      const maxDataCount = chartType === 'bar' ? 3 : 7;
      if (systemChart.data.labels.length >= maxDataCount) {
        systemChart.data.labels.shift();
        systemChart.data.datasets.forEach(ds => ds.data.shift());
      }

      systemChart.data.labels.push(time);
      systemChart.data.datasets[0].data.push(cpu);
      systemChart.data.datasets[1].data.push(ram);
      systemChart.data.datasets[2].data.push(disk);
      systemChart.update();

      pieChart.data.datasets[0].data = [cpu, ram, disk];
      pieChart.update();

      const recordList = document.getElementById('recordList');
      const recordItem = document.createElement('div');
      recordItem.classList.add('record');
      recordItem.textContent = `${time} - CPU: ${cpu}%, RAM: ${ram}%, Disk: ${disk}%`;

      const records = recordList.querySelectorAll('.record');
      if (records.length >= 5) {
        recordList.removeChild(records[0]);
      }
      recordList.appendChild(recordItem);
    } catch (err) {
      console.error('데이터 업데이트 실패:', err);
    }
  }

  function startInterval() {
    if (intervalHandle) clearInterval(intervalHandle);
    intervalHandle = setInterval(updateChart, updateInterval);
  }

  document.getElementById('viewSelector').addEventListener('change', (e) => {
    const newType = e.target.value;
    chartType = newType;
    const chartTitle = document.getElementById('chartTitle');
    chartTitle.textContent = newType === 'line' ? '실시간 라인 그래프' : '실시간 막대 그래프';

    const labels = [...systemChart.data.labels];
    const dataset0 = [...systemChart.data.datasets[0].data];
    const dataset1 = [...systemChart.data.datasets[1].data];
    const dataset2 = [...systemChart.data.datasets[2].data];

    systemChart.destroy();
    systemChart = createSystemChart(newType);

    const limit = newType === 'bar' ? 3 : 7;
    systemChart.data.labels = labels.slice(-limit);
    systemChart.data.datasets[0].data = dataset0.slice(-limit);
    systemChart.data.datasets[1].data = dataset1.slice(-limit);
    systemChart.data.datasets[2].data = dataset2.slice(-limit);

    systemChart.update();
  });

  document.getElementById("intervalSelector").addEventListener("change", e => {
    updateInterval = parseInt(e.target.value);
    startInterval();
  });

  updateChart();
  startInterval();
</script>
